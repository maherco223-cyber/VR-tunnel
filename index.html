<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Puff VR Tunnel</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
    body { margin:0; overflow:hidden; font-family:sans-serif; }
    #ui {
      position:absolute; inset:0;
      background:rgba(0,0,0,0.9);
      color:white;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
    }
    .panel {
      text-align:center;
      background:#000;
      padding:30px;
      border-radius:20px;
    }
    button {
      padding:15px 30px;
      font-size:18px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      background:#ff00ff;
      color:white;
    }
    input { margin-top:10px; }
  </style>
</head>

<body>

<!-- UI -->
<div id="ui">
  <div class="panel">
    <h1>Puff VR Ride</h1>
    <p>On Quest: <b>long-press</b> to select multiple videos</p>
    <input type="file" id="fileInput" multiple accept="video/*"><br><br>
    <button onclick="startRide()">ENTER VR</button>
  </div>
</div>

<!-- SCENE -->
<a-scene id="scene" style="display:none" renderer="antialias:true">
  <a-assets id="assets"></a-assets>

  <a-sky color="#030014"></a-sky>

  <!-- Tunnel Group -->
  <a-entity id="tunnelGroup">
    <a-cylinder
      radius="30"
      height="2000"
      open-ended="true"
      rotation="90 0 0"
      position="0 0 -1000"
      material="side:double; color:#4facfe; opacity:0.15">
    </a-cylinder>

    <a-entity id="screens"></a-entity>
  </a-entity>

  <!-- Player (STATIC) -->
  <a-entity id="rig" position="0 1.6 0">
    <a-camera></a-camera>

    <!-- Controllers -->
    <a-entity laser-controls="hand:left"></a-entity>
    <a-entity laser-controls="hand:right"></a-entity>

    <!-- Exit Button -->
    <a-box id="exitBtn"
      position="0 -0.3 -0.8"
      scale="0.25 0.12 0.05"
      color="#ff3333">
      <a-text value="EXIT" align="center" position="0 0 0.6"></a-text>
    </a-box>
  </a-entity>
</a-scene>

<script>
const ui = document.getElementById('ui');
const scene = document.getElementById('scene');
const assets = document.getElementById('assets');
const screens = document.getElementById('screens');
const tunnel = document.getElementById('tunnelGroup');
const fileInput = document.getElementById('fileInput');

let speed = 0.8;
let paused = false;

/* EXIT VR SAFELY */
document.getElementById('exitBtn').addEventListener('click', () => {
  if (scene.is('vr-mode')) {
    scene.exitVR();
    setTimeout(() => location.reload(), 500);
  } else {
    location.reload();
  }
});

/* START */
function startRide() {
  const files = [...fileInput.files];
  if (!files.length) {
    alert("Select at least one video");
    return;
  }

  ui.style.display = 'none';
  scene.style.display = 'block';

  files.forEach((file, i) => {
    const video = document.createElement('video');
    video.id = `vid${i}`;
    video.src = URL.createObjectURL(file);
    video.loop = true;
    video.preload = "metadata";
    video.crossOrigin = "anonymous";
    assets.appendChild(video);

    const screen = document.createElement('a-video');
    screen.setAttribute('src', `#vid${i}`);
    screen.setAttribute('width', '14');
    screen.setAttribute('height', '8');

    const angle = i * 0.6;
    const radius = 18;

    const x = Math.cos(angle) * radius;
    const y = Math.sin(angle) * radius + 5;
    const z = -i * 30;

    screen.setAttribute('position', `${x} ${y} ${z}`);
    screen.setAttribute('rotation', `0 ${-angle * 57.3 + 90} 0`);

    screens.appendChild(screen);
  });

  scene.enterVR();
}

/* REAL TUNNEL MOVEMENT */
AFRAME.registerComponent('tunnel-move', {
  tick() {
    if (paused) return;

    tunnel.object3D.position.z += speed;

    if (tunnel.object3D.position.z > 1000) {
      tunnel.object3D.position.z = 0;
    }

    document.querySelectorAll('a-video').forEach(screen => {
      const v = document.getElementById(
        screen.getAttribute('src').substring(1)
      );

      screen.object3D.position.z += speed;

      const dist = Math.abs(screen.object3D.position.z);

      if (dist < 60) {
        if (v.paused) v.play();
        v.volume = Math.max(0, 1 - dist / 60);
      } else {
        v.pause();
      }

      // recycle forward
      if (screen.object3D.position.z > 20) {
        screen.object3D.position.z -= 1600;
      }
    });

    // subtle rotation for immersion
    tunnel.object3D.rotation.z += 0.0004;
  }
});

tunnel.setAttribute('tunnel-move', '');
</script>

</body>
</html>
